<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Missions - Crime Lords</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="container glassmorphic">

    <div id="header-placeholder"></div>

    <section class="missions">
      <h2><i class="fa-solid fa-gun"></i> Missions</h2>

      <label for="mission-select">Select a Mission:</label>
      <select id="mission-select"></select>

      <div id="tasks" class="task-list"></div>
    </section>

    <div id="navbar-placeholder"></div>

  </div>

  <script src="script.js"></script>

  <script>
    const missionsData = [];
    const unlockedMissions = parseInt(localStorage.getItem("unlockedMissions")) || 1;

    for (let m = 1; m <= 10; m++) {
      const mission = {
        name: `Mission ${m}`,
        unlocked: m <= unlockedMissions,
        tasks: []
      };
      for (let t = 1; t <= 10; t++) {
        mission.tasks.push({
          id: t,
          name: `Task ${t}`,
          xp: m * 10 + t * 2,
          cash: m * 20 + t * 5,
          energy: 5 + t
        });
      }
      missionsData.push(mission);
    }

    const missionSelect = document.getElementById("mission-select");
    const tasksDiv = document.getElementById("tasks");

    function populateDropdown() {
      missionSelect.innerHTML = '';
      missionsData.forEach((m, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = m.unlocked ? m.name : `${m.name} (Locked)`;
        opt.disabled = !m.unlocked;
        missionSelect.appendChild(opt);
      });
    }

    function showTasks(index) {
      const mission = missionsData[index];
      if (!mission.unlocked) return;

      tasksDiv.innerHTML = '';
      mission.tasks.forEach(task => {
        const btn = document.createElement('button');
        btn.textContent = `${task.name} — XP: ${task.xp}, Cash: $${task.cash}, Energy: ${task.energy}`;
        btn.className = 'task-btn';

        const taskKey = `mission${index}-task${task.id}`;
        if (localStorage.getItem(taskKey)) {
          btn.disabled = true;
          btn.textContent += ' ✅';
        }

        btn.onclick = () => {
          const currentEnergy = parseInt(localStorage.getItem('energy')) || 100;
          if (currentEnergy < task.energy) {
            alert("Not enough energy!");
            return;
          }

          // Reduce energy
          localStorage.setItem('energy', currentEnergy - task.energy);

          // Add XP and cash
          let cash = parseInt(localStorage.getItem("cash") || "100");
          let xp = parseInt(localStorage.getItem("xp") || "0");
          cash += task.cash;
          xp += task.xp;
          localStorage.setItem("cash", cash);
          localStorage.setItem("xp", xp);

          // Mark task complete
          localStorage.setItem(taskKey, "completed");
          btn.disabled = true;
          btn.textContent += " ✅";

          // Check if all tasks are completed
          const allCompleted = mission.tasks.every(t => localStorage.getItem(`mission${index}-task${t.id}`));
          if (allCompleted && index + 1 < missionsData.length && !missionsData[index + 1].unlocked) {
            missionsData[index + 1].unlocked = true;
            localStorage.setItem("unlockedMissions", index + 2);
            alert(`${missionsData[index + 1].name} is now unlocked!`);
            populateDropdown();
          }

          updateStats(); // update top stats
        };

        tasksDiv.appendChild(btn);
      });
    }

    // Load initial view
    populateDropdown();
    showTasks(0);
    missionSelect.addEventListener("change", e => showTasks(parseInt(e.target.value)));

    // Load header and navbar
    fetch("header.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("header-placeholder").innerHTML = data;
      });

    fetch("navbar.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("navbar-placeholder").innerHTML = data;
      });
  </script>
</body>
</html>
